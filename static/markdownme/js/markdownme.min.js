markdownEditorState={WRITE:0,PREVIEW:1,HISTORY:2},Dropzone.autoDiscover=!1,document.addEventListener("DOMContentLoaded",function(a){if(document.cookie&&""!==document.cookie){var b="; "+document.cookie,c=b.split("; csrftoken=");2==c.length&&(markdownME.csrftoken=c.pop().split(";").shift())}for(var d=document.querySelectorAll("div.markdownme-widget"),e=0;e<d.length;e++){var f=d[e];f.textarea=f.querySelector(".markdownme-textarea"),f.preview=f.querySelector(".markdownme-preview"),f.currentState=markdownEditorState.WRITE;var g=document.getElementsByName("markdown_identifier")[e].value;if(!0===markdownME.fileUploadAllowed){f.dropzone=f.querySelector(".dropzone"),f.dropzone=new Dropzone(f.dropzone,{url:markdownME.uploadUrl}),f.dropzone.options.autoProcessQueue=!0,f.dropzone.options.uploadMultiple=!1,f.dropzone.options.parallelUploads=5,f.dropzone.options.maxFilesize=markdownME.maxFilesize,f.dropzone.options.maxThumbnailFilesize=10,f.dropzone.options.acceptedFiles=markdownME.allowedFileTypes,f.dropzone.options.addRemoveLinks=!0,f.dropzone.options.params={markdown_identifier:g},f.dropzone.options.headers={"X-CSRFToken":markdownME.csrftoken},f.dropzone.on("removedfile",function(a){var b=new XMLHttpRequest;b.open("POST",markdownME.deleteUrl,!0),b.setRequestHeader("Content-type","application/x-www-form-urlencoded"),b.setRequestHeader("X-CSRFToken",markdownME.csrftoken),b.send("filename="+a.previewElement.querySelector("[data-dz-name]").innerHTML+"&markdown_identifier="+g)}),f.dropzone.on("complete",function(a){a.previewElement.addEventListener("click",function(){f.insertMarkdownLink(a.previewElement.querySelector("[data-dz-name]").innerHTML,a.markdownLink)})}),f.dropzone.on("success",function(a,b){var c=b.url;a.previewElement.querySelector("[data-dz-name]").innerHTML=c.substring(c.lastIndexOf("/")+1),a.markdownLink=c});var h=new XMLHttpRequest;h.open("GET",markdownME.fileListUrl+"?markdown_identifier="+g,!0),h.onload=function(){if(h.status>=200&&h.status<300)for(var a=JSON.parse(h.responseText),b=0;b<a.files.length;b++){var c=a.files[b],d={name:c.url.substring(c.url.lastIndexOf("/")+1),size:c.size};f.dropzone.emit("addedfile",d),f.dropzone.createThumbnailFromUrl(d,c.url),f.dropzone.emit("complete",d),d.markdownLink=c.url}},h.send()}if(markdownME.historyAllowed){f.history=f.querySelector(".markdownme-history");var i=new XMLHttpRequest;i.open("GET",markdownME.historyUrl+"?markdown_identifier="+g,!0),i.onload=function(){if(i.status>=200&&i.status<300){var a=JSON.parse(i.responseText),b=f.querySelector(".markdownme-toolbar-history-select");f.historyEntries=[];for(var c=0;c<a.entries.length;c++){var d=a.entries[c],e=document.createElement("option");e.setAttribute("value",c),e.appendChild(document.createTextNode(d.date)),b.appendChild(e),f.historyEntries[c]=d.text}0===f.historyEntries.length?f.historyAvailable=!1:f.historyAvailable=!0}else f.historyAvailable=!1;!1===f.historyAvailable&&(f.querySelector(".markdownme-toolbar-history-select").classList.add("markdownme-hidden"),f.querySelector(".markdownme-toolbar-button-revert").classList.add("markdownme-hidden"),f.querySelector(".markdownme-toolbar-button-history").classList.add("markdownme-hidden"))},i.send(),f.changeEditingState=function(a){var b=f.querySelector(".markdownme-toolbar-history-select"),c=f.querySelector(".markdownme-toolbar-button-revert"),d=f.querySelector(".markdownme-toolbar-button-history"),e=f.querySelector(".markdownme-toolbar-button-preview");if(!0===markdownME.fileUploadAllowed)var g=f.querySelector(".dropzone");switch(f.currentState=a,a){case markdownEditorState.WRITE:f.preview.classList.add("markdownme-hidden"),f.textarea.classList.remove("markdownme-hidden"),f.history.classList.add("markdownme-hidden"),b.classList.add("markdownme-hidden"),c.classList.add("markdownme-hidden"),d.classList.remove("markdownme-toolbar-button-selected"),e.classList.remove("markdownme-toolbar-button-selected"),!0===markdownME.fileUploadAllowed&&g.classList.remove("markdownme-hidden");break;case markdownEditorState.PREVIEW:f.preview.classList.remove("markdownme-hidden"),f.textarea.classList.add("markdownme-hidden"),f.history.classList.add("markdownme-hidden"),b.classList.add("markdownme-hidden"),c.classList.add("markdownme-hidden"),d.classList.remove("markdownme-toolbar-button-selected"),e.classList.add("markdownme-toolbar-button-selected"),!0===markdownME.fileUploadAllowed&&g.classList.add("markdownme-hidden");break;case markdownEditorState.HISTORY:f.preview.classList.add("markdownme-hidden"),f.textarea.classList.add("markdownme-hidden"),f.history.classList.remove("markdownme-hidden"),b.classList.remove("markdownme-hidden"),c.classList.remove("markdownme-hidden"),d.classList.add("markdownme-toolbar-button-selected"),e.classList.remove("markdownme-toolbar-button-selected"),!0===markdownME.fileUploadAllowed&&g.classList.add("markdownme-hidden")}},f.diffHistory=function(){if(0!==f.historyEntries.length){var a=f.querySelector(".markdownme-history-previous"),b=f.textarea.value.replace(/\r/g,""),c=f.historyEntries[f.querySelector(".markdownme-toolbar-history-select").value].replace(/\r/g,"");if(markdownME.twoPaneHistory){f.querySelector(".markdownme-history-current").innerHTML=b.replace(/\r?\n/g,"<br>")}var e=new Diff,g=e.diff_main(b,c);e.diff_cleanupSemantic(g),a.innerHTML=e.diff_prettyHtml(g)}},f.querySelector(".markdownme-toolbar-button-history").addEventListener("click",function(){f.currentState!=markdownEditorState.HISTORY?(f.changeEditingState(markdownEditorState.HISTORY),f.diffHistory()):f.changeEditingState(markdownEditorState.WRITE)}),f.querySelector(".markdownme-toolbar-button-revert").addEventListener("click",function(){f.textarea.value=f.historyEntries[f.querySelector(".markdownme-toolbar-history-select").value],f.changeEditingState(markdownEditorState.WRITE)}),markdownME.twoPaneHistory&&f.querySelector(".markdownme-history-current").addEventListener("scroll",function(){var a=f.querySelector(".markdownme-history-current"),b=f.querySelector(".markdownme-history-previous");b.scrollTop=b.scrollHeight*a.scrollTop/a.scrollHeight}),f.querySelector(".markdownme-toolbar-history-select").addEventListener("change",function(){f.diffHistory()})}else f.historyAvailable=!1,f.changeEditingState=function(a){var b=f.querySelector(".markdownme-toolbar-button-preview");if(!0===markdownME.fileUploadAllowed)var c=f.querySelector(".dropzone");switch(f.currentState=a,a){case markdownEditorState.WRITE:f.preview.classList.add("markdownme-hidden"),f.textarea.classList.remove("markdownme-hidden"),b.classList.remove("markdownme-toolbar-button-selected"),!0===markdownME.fileUploadAllowed&&c.classList.remove("markdownme-hidden");break;case markdownEditorState.PREVIEW:f.preview.classList.remove("markdownme-hidden"),f.textarea.classList.add("markdownme-hidden"),b.classList.add("markdownme-toolbar-button-selected"),!0===markdownME.fileUploadAllowed&&c.classList.add("markdownme-hidden");break;case markdownEditorState.HISTORY:}};f.insertMarkdownLink=function(a,b){if(b){var c=b.substr(b.lastIndexOf(".")+1);"png"===c||"bmp"===c||"gif"===c||"jpg"===c||"jpeg"===c||"ico"===c?f.insertAroundSelection("","!["+a+"]("+b+")"):f.insertAroundSelection("","["+a+"]("+b+")")}},f.insertAroundSelection=function(a,b){if(f.textarea.selectionStart||"0"==f.textarea.selectionStart){var c=f.textarea.selectionStart,d=f.textarea.selectionEnd;"undefined"!=typeof InstallTrigger?(f.textarea.value=f.textarea.value.substring(0,c)+a+f.textarea.value.substring(c,d)+b+f.textarea.value.substring(d,f.textarea.value.length),f.textarea.dispatchEvent(new Event("change",{bubbles:!0}))):(f.textarea.focus(),document.execCommand("insertText",!1,a+f.textarea.value.substring(c,d)+b)),f.textarea.selectionStart=d+a.length+b.length,f.textarea.selectionEnd=f.textarea.selectionStart,"](http://)"===b&&(f.textarea.selectionStart-=1,f.textarea.selectionEnd-=1)}else f.textarea.value+=a+b;"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch||(f.textarea.blur(),f.textarea.focus())},f.insertList=function(a){if(f.textarea.selectionStart||"0"==f.textarea.selectionStart){var b=f.textarea.value.substring(0,f.textarea.selectionStart).lastIndexOf("\n")+1,c=f.textarea.value.substring(b,f.textarea.selectionEnd),d=c;if(!0===a){d="1. "+d;var e=1;d=d.replace(/\n/g,function(){return"\n"+ ++e+". "})}else d="- "+d,d=d.replace(/\n/g,"\n- ");"undefined"!=typeof InstallTrigger?(f.textarea.value=f.textarea.value.substring(0,b)+d+f.textarea.value.substring(b+d.length,f.textarea.value.length),f.textarea.dispatchEvent(new Event("change",{bubbles:!0}))):(f.textarea.focus(),f.textarea.selectionStart=b,f.textarea.selectionEnd=b+c.length,document.execCommand("insertText",!1,d)),f.textarea.selectionStart=b+d.length,f.textarea.selectionEnd=f.textarea.selectionStart}"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch||(f.textarea.blur(),f.textarea.focus())},f.toolbarHotkeyHandler=function(a){if(document.activeElement===f.textarea&&a.ctrlKey&&!a.altKey&&!a.shiftKey)switch(a.keyCode){case 66:f.insertAroundSelection("**","**");break;case 73:f.insertAroundSelection("_","_")}},f.addEventListener("keyup",f.toolbarHotkeyHandler,!1),f.querySelector(".markdownme-toolbar-button-bold").addEventListener("click",function(){f.insertAroundSelection("**","**")},!1),f.querySelector(".markdownme-toolbar-button-italic").addEventListener("click",function(){f.insertAroundSelection("_","_")},!1),f.querySelector(".markdownme-toolbar-button-unordered-list").addEventListener("click",function(){f.insertList(!1)},!1),f.querySelector(".markdownme-toolbar-button-ordered-list").addEventListener("click",function(){f.insertList(!0)},!1),f.querySelector(".markdownme-toolbar-button-link").addEventListener("click",function(){f.insertAroundSelection("[","](http://)")},!1),f.querySelector(".markdownme-toolbar-button-preview").addEventListener("click",function(){if(f.currentState!=markdownEditorState.PREVIEW){var a=new showdown.Converter({strikethrough:"true"});if(markdownME.iframePreview){var b=f.querySelector(".markdownme-preview"),c=f.querySelector(".markdownme-preview-iframe");b.removeChild(c);var d=document.createElement("iframe");d.classList=c.classList,markdownME.safePreview&&d.setAttribute("sandbox","allow-same-origin"),b.appendChild(d),d.contentWindow.document.open(),d.contentWindow.document.write(a.makeHtml(f.textarea.value)),d.contentWindow.document.close()}else{f.querySelector(".markdownme-preview-div").innerHTML=a.makeHtml(f.textarea.value)}f.changeEditingState(markdownEditorState.PREVIEW)}else f.changeEditingState(markdownEditorState.WRITE)},!1)}});